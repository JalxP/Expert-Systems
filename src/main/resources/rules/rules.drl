package com.sample

import model.Patient;
import model.MedicalChart;
 
rule "Idade"
	when
		$p: Patient(accepted, age < 18);
	then
		$p.setAccepted(false);
		$p.setResults("O paciente " + $p.getName() + " não é elegível – Menor de idade.");
		update($p);
end

rule "Indicador OMS"
	when
		$p: Patient(accepted);
		$mc: MedicalChart(patientID == $p.getPatientID(), whoStatus != 0 && whoStatus != 1);
	then
		$p.setAccepted(false);
		$p.setResults("O paciente " + $p.getName() + " não é elegível – Não tem o indicador de desempenho da OMS requerido.");
		update($p);
end

rule "Diagnóstico"
	when
		$p: Patient(accepted);
		$mc: MedicalChart(patientID == $p.getPatientID(), !squamousCellCarcinoma, !undifferentiatedCarcinoma, !adenocarcinomaI, !adenocarcinomaII);	
	then
		$p.setAccepted(false);
		$p.setResults("O paciente " + $p.getName() + " não é elegível – Não tem o diagnóstico requerido (Carcinomas, Adenocarcinoma (Siewert I ou II).");
		update($p);
end

rule "Doença Clinica"
	when
		$p: Patient(accepted);
		$mc: MedicalChart(patientID == $p.getPatientID(), cancerStage != 2, cancerStage != 3);	
	then
		$p.setAccepted(false);
		$p.setResults("O paciente " + $p.getName() + " não é elegível – Não tem uma doença num dos estadios requeridos (II ou III).");
		update($p);
end

rule "Distância do Tumor"
	when
		$p: Patient(accepted);
		$mc: MedicalChart(patientID == $p.getPatientID(), distanceToUpperBorder < 3);	
	then
		$p.setAccepted(false);
		$p.setResults("O paciente " + $p.getName() + " não é elegível – Não tem uma distância entre a borda superior\ndo tumor abaixo do esfincter superior do esófago requerida (pelo menos 3 cm).");
		update($p);
end

rule "Consentimento Informado"
	when
		$p: Patient(accepted, !consent);	
	then
		$p.setAccepted(false);
		$p.setResults("O paciente " + $p.getName() + " não é elegível – Não tem um termo de consentimento informado.");
		update($p);
end

rule "Mulheres Grávidas ou Lactantes"
	when
		$p: Patient(accepted, pregnant || lactant);	
	then
		$p.setAccepted(false);
		$p.setResults("O paciente " + $p.getName() + " não é elegível – Tem uma gravidez a decorrer ou está lactante.");
		update($p);
end

rule "Radioterapia Prévia"
	when
		$p: Patient(accepted);
		$mc: MedicalChart(patientID == $p.getPatientID(), previousRadiotherapy);	
	then
		$p.setAccepted(false);
		$p.setResults("O paciente " + $p.getName() + " não é elegível – Realizou uma radioterapia torácica previamente.");
		update($p);
end

rule "Infeção Ativa"
	when
		$p: Patient(accepted);
		$mc: MedicalChart(patientID == $p.getPatientID(), activeInfection);	
	then
		$p.setAccepted(false);
		$p.setResults("O paciente " + $p.getName() + " não é elegível – Tem uma infeção ativa.");
		update($p);
end

rule "Neutrófilos"
	when
		$p: Patient(accepted);
		$mc: MedicalChart(patientID == $p.getPatientID(), neutrophils < 1.5);	
	then
		$p.setAccepted(false);
		$p.setResults("O paciente " + $p.getName() + " não é elegível – Contagem de neutrófilos reduzida.");
		update($p);
end

rule "Plaquetas"
	when
		$p: Patient(accepted);
		$mc: MedicalChart(patientID == $p.getPatientID(), platelets < 100);	
	then
		$p.setAccepted(false);
		$p.setResults("O paciente " + $p.getName() + " não é elegível – Contagem de plaquetas reduzida.");
		update($p);
end

rule "Bilirrubina Total"
	when
		$p: Patient(accepted);
		$mc: MedicalChart(patientID == $p.getPatientID(), bilirubin > 1.5);	
	then
		$p.setAccepted(false);
		$p.setResults("O paciente " + $p.getName() + " não é elegível – Concentração sérica de bilirrubina elevada.");
		update($p);
end

rule "Creatinina"
	when
		$p: Patient(accepted);
		$mc: MedicalChart(patientID == $p.getPatientID(), creatinine > 120);	
	then
		$p.setAccepted(false);
		$p.setResults("O paciente " + $p.getName() + " não é elegível – Creatinina elevada.");
		update($p);
end

rule "Volume Pulmonar"
	when
		$p: Patient(accepted);
		$mc: MedicalChart(patientID == $p.getPatientID(), pulmonaryFunction < 1.5);	
	then
		$p.setAccepted(false);
		$p.setResults("O paciente " + $p.getName() + " não é elegível – Volume pulmonar reduzido.");
		update($p);
end

rule "Elegível"
	no-loop true
	when
		$p: Patient(accepted);	
	then
		$p.setResults("O paciente " + $p.getName() + " é elegível.");
		update($p);
end

rule "Efetuar Endoscopia"
	when
		$p: Patient(accepted);
		$mc: MedicalChart(patientID == $p.getPatientID(), endoscopicLesions);
	then
		String s = $p.getResults();
		s += "\nTerá de efetuar uma endoscopia 6 semanas após o início do tratamento.";
		$p.setResults(s);
end

rule "Efetuar Broncoscopia"
	when
		$p: Patient(accepted);
		$mc: MedicalChart(patientID == $p.getPatientID(), respiratoryTreeAffected);
	then
		String s = $p.getResults();
		s += "\nTerá de efetuar uma broncoscopia.";
		$p.setResults(s);
end